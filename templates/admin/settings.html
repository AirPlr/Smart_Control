{% extends 'admin/base.html' %}

{% block title %}Impostazioni Sistema - Admin{% endblock %}

{% block styles %}
<style>
.settings-section {
    margin-bottom: 2rem;
}

.system-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-indicator.online {
    background-color: #28a745;
    animation: pulse 2s infinite;
}

.status-indicator.offline {
    background-color: #dc3545;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    border: none;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.position-badge {
    background: #e3f6fd;
    color: #0066cc;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.85rem;
    margin: 0.2rem;
    display: inline-block;
}

.action-button {
    transition: all 0.3s ease;
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-cogs me-2"></i>Impostazioni Sistema
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Impostazioni</li>
            </ol>
        </nav>
    </div>

    <!-- Sistema Overview -->
    <div class="settings-section">
        <h4><i class="fas fa-server me-2"></i>Stato Sistema</h4>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ system_info.cpu_usage }}%</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ system_info.memory_usage }}%</div>
                    <div class="metric-label">Memoria</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ system_info.disk_usage }}%</div>
                    <div class="metric-label">Disco</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value">{{ database_stats.total_users }}</div>
                    <div class="metric-label">Utenti Totali</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Informazioni Sistema</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Piattaforma:</strong> {{ system_info.platform }}</p>
                        <p><strong>Python:</strong> {{ system_info.python_version }}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="system-status">
                            <div class="status-indicator online"></div>
                            <span>Sistema Online</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-warning action-button me-2" onclick="restartApp()">
                        <i class="fas fa-redo me-2"></i>Riavvia Applicazione
                    </button>
                    <button class="btn btn-info action-button" onclick="clearLogs()">
                        <i class="fas fa-broom me-2"></i>Pulisci Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Management -->
    <div class="settings-section">
        <h4><i class="fas fa-database me-2"></i>Gestione Database</h4>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Statistiche Database</h6>
                        <ul class="list-unstyled">
                            <li><strong>Utenti:</strong> {{ database_stats.total_users }}</li>
                            <li><strong>Consulenti:</strong> {{ database_stats.total_consultants }}</li>
                            <li><strong>Appuntamenti:</strong> {{ database_stats.total_appointments }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Backup</h6>
                        {% if backup_info.last_backup %}
                            <p><strong>Ultimo backup:</strong> {{ backup_info.last_backup }}</p>
                            <p><strong>Backup totali:</strong> {{ backup_info.backup_count }}</p>
                        {% else %}
                            <p class="text-warning">Nessun backup trovato</p>
                        {% endif %}
                        
                        <button class="btn btn-success action-button" onclick="createBackup()">
                            <i class="fas fa-save me-2"></i>Crea Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VPN Management -->
    <div class="settings-section">
        <h4><i class="fas fa-shield-alt me-2"></i>Gestione VPN</h4>
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="system-status mb-3">
                            <div class="status-indicator {{ 'online' if vpn_status.connected else 'offline' }}"></div>
                            <span>VPN {{ 'Connessa' if vpn_status.connected else 'Disconnessa' }}</span>
                        </div>
                        {% if vpn_status.connected %}
                            <p><strong>IP:</strong> {{ vpn_status.ip }}</p>
                            <p><strong>Posizione:</strong> {{ vpn_status.location }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        {% if vpn_status.connected %}
                            <button class="btn btn-danger action-button" onclick="disconnectVPN()">
                                <i class="fas fa-times me-2"></i>Disconnetti VPN
                            </button>
                        {% else %}
                            <button class="btn btn-success action-button" onclick="connectVPN()">
                                <i class="fas fa-link me-2"></i>Connetti VPN
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestione Posizioni -->
    <div class="settings-section">
        <h4><i class="fas fa-briefcase me-2"></i>Gestione Posizioni Consulenti</h4>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Posizioni Esistenti</h6>
                        <div class="mb-3">
                            {% for position in positions %}
                                <div class="position-badge">
                                    {{ position.nome }}
                                    <span class="badge bg-primary ms-1">{{ position.consultants|length }}</span>
                                    {% if position.consultants|length == 0 %}
                                        <button class="btn btn-sm btn-outline-danger ms-1 border-0" 
                                                onclick="deletePosition({{ position.id }}, '{{ position.nome }}')"
                                                title="Elimina posizione">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-primary ms-1 border-0" 
                                            onclick="editPosition({{ position.id }}, '{{ position.nome }}')"
                                            title="Modifica posizione">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Aggiungi Nuova Posizione</h6>
                        <form method="POST" action="{{ url_for('admin.manage_positions') }}">
                            <input type="hidden" name="action" value="create">
                            <div class="input-group">
                                <input type="text" class="form-control" name="nome" placeholder="Nome posizione" required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestione Utenti Semplificata -->
    <div class="settings-section">
        <h4><i class="fas fa-users me-2"></i>Accesso Rapido Utenti</h4>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Azioni Rapide</h6>
                        <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary action-button me-2">
                            <i class="fas fa-user-plus me-2"></i>Nuovo Utente/Consulente
                        </a>
                        <a href="{{ url_for('admin.users') }}" class="btn btn-outline-primary action-button">
                            <i class="fas fa-list me-2"></i>Gestisci Tutti
                        </a>
                    </div>
                    <div class="col-md-6">
                        <h6>Statistiche Rapide</h6>
                        <p><strong>Totale Utenti:</strong> {{ database_stats.total_users }}</p>
                        <p><strong>Totale Consulenti:</strong> {{ database_stats.total_consultants }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per modifica posizione -->
<div class="modal fade" id="editPositionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica Posizione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.manage_positions') }}">
                <div class="modal-body">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" name="position_id" id="editPositionId">
                    <div class="mb-3">
                        <label for="editPositionName" class="form-label">Nome Posizione</label>
                        <input type="text" class="form-control" name="new_name" id="editPositionName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Funzioni per azioni sistema
function restartApp() {
    if (confirm('Riavviare l\'applicazione? Tutti gli utenti saranno disconnessi.')) {
        fetch('{{ url_for("admin.system_settings") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'action=restart_app'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => location.reload(), 3000);
            } else {
                showAlert('error', data.error);
            }
        })
        .catch(error => showAlert('error', 'Errore di rete'));
    }
}

function createBackup() {
    showAlert('info', 'Creazione backup in corso...');
    
    fetch('{{ url_for("admin.system_settings") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'action=backup_db'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Backup creato: ${data.backup_path}`);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('error', data.error);
        }
    })
    .catch(error => showAlert('error', 'Errore durante il backup'));
}

function clearLogs() {
    if (confirm('Pulire tutti i log dell\'applicazione?')) {
        fetch('{{ url_for("admin.system_settings") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'action=clear_logs'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Log puliti con successo');
            } else {
                showAlert('error', data.error);
            }
        })
        .catch(error => showAlert('error', 'Errore durante pulizia log'));
    }
}

function connectVPN() {
    showAlert('info', 'Connessione VPN in corso...');
    
    fetch('{{ url_for("admin.system_settings") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'action=vpn_connect'
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.success ? 'success' : 'error', data.message || data.error);
        if (data.success) setTimeout(() => location.reload(), 2000);
    })
    .catch(error => showAlert('error', 'Errore di connessione VPN'));
}

function disconnectVPN() {
    fetch('{{ url_for("admin.system_settings") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'action=vpn_disconnect'
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.success ? 'success' : 'error', data.message || data.error);
        if (data.success) setTimeout(() => location.reload(), 2000);
    })
    .catch(error => showAlert('error', 'Errore di disconnessione VPN'));
}

// Gestione posizioni
function editPosition(id, nome) {
    document.getElementById('editPositionId').value = id;
    document.getElementById('editPositionName').value = nome;
    new bootstrap.Modal(document.getElementById('editPositionModal')).show();
}

function deletePosition(id, nome) {
    if (confirm(`Eliminare la posizione "${nome}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin.manage_positions") }}';
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'delete';
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'position_id';
        idInput.value = id;
        
        form.appendChild(actionInput);
        form.appendChild(idInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Utility per alert
function showAlert(type, message) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'info': 'alert-info',
        'warning': 'alert-warning'
    }[type] || 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertAdjacentHTML('afterbegin', alertHtml);
}
</script>
{% endblock %}
