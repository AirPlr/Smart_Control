{% extends 'admin/base.html' %}

{% block title %}Crea Nuovo Utente - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Crea Nuovo Utente</h2>
                <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Torna alla Lista
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <div class="form-text">Minimo 6 caratteri</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">Ruolo <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="">Seleziona ruolo</option>
                                        <option value="dealer">Dealer</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="language" class="form-label">Lingua</label>
                                    <select class="form-select" id="language" name="language">
                                        <option value="it">Italiano</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="license_code" class="form-label">Codice Licenza</label>
                                    <input type="text" class="form-control" id="license_code" name="license_code" placeholder="Opzionale">
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h5 class="mb-3">Dati Consulente</h5>
                        <p class="text-muted small">Ogni utente è automaticamente anche un consulente. Compila i dati aggiuntivi:</p>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nome_consulente" class="form-label">Nome Completo</label>
                                    <input type="text" class="form-control" id="nome_consulente" name="nome_consulente" 
                                           placeholder="Se vuoto, userà l'username">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Telefono</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="Opzionale">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="residency" class="form-label">Residenza</label>
                                    <input type="text" class="form-control" id="residency" name="residency" placeholder="Opzionale">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cf" class="form-label">Codice Fiscale</label>
                                    <input type="text" class="form-control" id="cf" name="cf" placeholder="Opzionale" maxlength="16">
                                </div>
                            </div>
                        </div>

                        <hr>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">Annulla</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-person-plus"></i> Crea Utente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-completa nome consulente con username
    const usernameField = document.getElementById('username');
    const nomeConsulentField = document.getElementById('nome_consulente');
    
    usernameField.addEventListener('input', function() {
        if (!nomeConsulentField.value.trim()) {
            nomeConsulentField.placeholder = `Nome: ${this.value || 'username'}`;
        }
    });
    
    // Validazione form
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;
        
        if (!username || !email || !password || !role) {
            e.preventDefault();
            alert('Tutti i campi obbligatori devono essere compilati');
            return;
        }
        
        if (password.length < 6) {
            e.preventDefault();
            alert('La password deve essere di almeno 6 caratteri');
            return;
        }
        
        // Validazione email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            e.preventDefault();
            alert('Inserisci un indirizzo email valido');
            return;
        }
        
        // Validazione CF se presente
        const cf = document.getElementById('cf').value.trim();
        if (cf && cf.length !== 16) {
            e.preventDefault();
            alert('Il Codice Fiscale deve essere di 16 caratteri');
            return;
        }
    });
});
</script>
{% endblock %}
