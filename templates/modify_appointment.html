<!DOCTYPE html>
{% extends 'base.html' %}
{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifica Appuntamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
</head>
<body>
    <div class="container mt-4">
        <h2>Modifica Appuntamento</h2>
    <form action="{{ url_for('main.modify_appointment', id=appointment.id) }}" method="POST">
        <div class="mb-3">
            <label class="form-label">Nome Cliente</label>
            <input list="client-list" class="form-control" name="nome_cliente" id="nome_cliente" value="{{ appointment.nome_cliente }}" required oninput="checkClient(this)">
            <datalist id="client-list">
                {% for client in clients %}
                <option value="{{ client.nome }}"></option>
                {% endfor %}
            </datalist>
            <small id="client-help" class="form-text text-muted">Se il cliente non esiste, verr√† registrato come nuovo.</small>
        </div>
        <script>
            function checkClient(input) {
                const options = document.getElementById("client-list").options;
                let found = false;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === input.value.trim()) {
                        found = true;
                        break;
                    }
                }
                const helpText = document.getElementById("client-help");
                helpText.textContent = found ? "Cliente esistente selezionato." : "Cliente non trovato. Verr√† registrato come nuovo.";
            }
        </script>
        <div class="mb-3">
            <label for="consultant">Seleziona Consulente:</label>
            <select id="consultant" class="form-control">
                <option value="" disabled selected>Scegli un consulente</option>
                {% for consultant in consultants %}
                <option value="{{ consultant.id }}">{{ consultant.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Lista dinamica dei consulenti selezionati -->
        <ul id="selected-consultants" class="mt-2"></ul>

        <!-- Input nascosto per inviare i consulenti selezionati -->
        <input type="hidden" name="consultants" id="consultants-input">

        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const consultantSelect = document.getElementById("consultant");
            const selectedConsultantsList = document.getElementById("selected-consultants");
            const consultantsInput = document.getElementById("consultants-input");
            let selectedConsultants = [];

            // Pre-popola i consulenti gi√† associati all'appuntamento
            {% if appointment.consultants %}
                {% for consultant in appointment.consultants %}
                    selectedConsultants.push({ 
                        id: "{{ consultant.id }}", 
                        name: "{{ consultant.nome }}" 
                    });
                {% endfor %}
                updateConsultantList();
            {% endif %}

            consultantSelect.addEventListener("change", function () {
                const consultantId = this.value;
                const consultantName = this.options[this.selectedIndex].text;

                if (consultantId && !selectedConsultants.some(c => c.id === consultantId)) {
                    selectedConsultants.push({ id: consultantId, name: consultantName });
                    updateConsultantList();
                }
            });

            function updateConsultantList() {
                selectedConsultantsList.innerHTML = "";
                selectedConsultants.forEach((consultant, index) => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        ${consultant.name} 
                        <button type="button" class="btn btn-sm btn-danger ml-2" onclick="removeConsultant(${index})">
                            üóëÔ∏è
                        </button>
                    `;
                    selectedConsultantsList.appendChild(li);
                });

                consultantsInput.value = JSON.stringify(selectedConsultants.map(c => c.id));
            }

            window.removeConsultant = function (index) {
                selectedConsultants.splice(index, 1);
                updateConsultantList();
            };
        });
        </script>

        <div class="mb-3">
            <label class="form-label">Indirizzo</label>
            <input type="text" class="form-control" name="indirizzo" value="{{ appointment.indirizzo or '' }}">
        </div>
        <div class="mb-3">
            <label class="form-label">Numero di Telefono</label>
            <input type="tel" class="form-control" name="numero_telefono" value="{{ appointment.numero_telefono }}" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Note</label>
            <textarea class="form-control" name="note">{{ appointment.note or '' }}</textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Tipologia di Appuntamento</label>
            <select class="form-select" name="tipologia" required>
                <option value="Assistenza" {% if appointment.tipologia == 'Assistenza' %}selected{% endif %}>Assistenza</option>
                <option value="Dimostrazione" {% if appointment.tipologia == 'Dimostrazione' %}selected{% endif %}>Dimostrazione</option>
                <option value="Consumabili" {% if appointment.tipologia == 'Consumabili' %}selected{% endif %}>Consumabili</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Stato</label>
            <select class="form-select" name="stato" id="stato" required>
                <option value="concluso" {% if appointment.stato == 'concluso' %}selected{% endif %}>Concluso</option>
                <option value="da richiamare" {% if appointment.stato == 'da richiamare' %}selected{% endif %}>Da Richiamare</option>
                <option value="non richiamare" {% if appointment.stato == 'non richiamare' %}selected{% endif %}>Non Richiamare</option>
            </select>
        </div>
        <div class="mb-3" id="recallDateContainer" style="display: {% if appointment.stato == 'da richiamare' %}block{% else %}none{% endif %};">
            <label class="form-label">Data di Richiamo</label>
            <input type="date" class="form-control" name="data_richiamo" value="{% if appointment.data_richiamo %}{{ appointment.data_richiamo.strftime('%Y-%m-%d') }}{% endif %}">
        </div>
        <div class="mb-3">
            <label class="form-label">Contatti Raccolti</label>
            <input type="number" class="form-control" name="nominativi_raccolti" value="{{ appointment.nominativi_raccolti }}">
        </div>
        <div class="mb-3">
            <label class="form-label">Appuntamenti Personali Presi</label>
            <input type="number" class="form-control" name="appuntamenti_personali" value="{{ appointment.appuntamenti_personali }}">
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="venduto" id="venduto" {% if appointment.venduto %}checked{% endif %}>
                    <label class="form-check-label" for="venduto">Vendita Conclusa</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="include_in_reports" id="include_in_reports" 
                           {% if appointment.include_in_reports %}checked{% endif %}>
                    <label class="form-check-label" for="include_in_reports">Includi nei Report</label>
                    <small class="form-text text-muted d-block">Deseleziona per escludere dai report</small>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Data Appuntamento</label>
            <input type="date" class="form-control" name="data_appuntamento" value="{{ appointment.data_appuntamento.strftime('%Y-%m-%d') }}" required>
        </div>
        <button type="submit" class="btn btn-success w-100">Salva Modifiche</button>
    </form>
    <div class="text-center mt-4">
        <a href="{{ url_for('main.appointments') }}" class="btn btn-secondary">Torna alla Lista Appuntamenti</a>
    </div>
</div>
    
   
</div>
</div>
</div>
<script>
document.getElementById('stato').addEventListener('change', function () {
    var recallDateContainer = document.getElementById('recallDateContainer');
    if (this.value === 'da richiamare') {
        recallDateContainer.style.display = 'block';
    } else {
        recallDateContainer.style.display = 'none';
    }
});
</script>

<!-- Script to disable venduto checkbox for specific tipologia -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const tipologiaSelect = document.querySelector('select[name="tipologia"]');
    const vendutoCheckbox = document.getElementById('venduto');
    const includeInReportsCheckbox = document.getElementById('include_in_reports');

    function updateVendutoAndReports() {
        const tipologia = tipologiaSelect.value;
        if (tipologia === 'Consegna' || tipologia === 'Redemo') {
            vendutoCheckbox.checked = false;
            vendutoCheckbox.disabled = true;
        } else {
            vendutoCheckbox.disabled = false;
        }
        
        // Per i consumabili, suggerisci di escludere dai report
        if (tipologia === 'Consumabili') {
            includeInReportsCheckbox.checked = false;
        } else {
            includeInReportsCheckbox.checked = true;
        }
    }

    tipologiaSelect.addEventListener('change', updateVendutoAndReports);
    updateVendutoAndReports();
});
</script>

    
    
</body>
</html>
{% endblock %}