{% extends 'base.html' %}
{% block title %}Calendario - Smart Control{% endblock %}

{% block head %}
<link href="https://fullcalendar.io/releases/fullcalendar/3.9.0/fullcalendar.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
<script src="https://fullcalendar.io/releases/fullcalendar/3.9.0/fullcalendar.min.js"></script>
<script src="https://fullcalendar.io/releases/fullcalendar/3.9.0/locale/it.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1 class="text-primary">Calendario</h1>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.add_event') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Nuovo Evento
            </a>
            <a href="{{ url_for('main.add_appointment') }}" class="btn btn-primary">
                <i class="bi bi-calendar-plus"></i> Nuovo Appuntamento
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-9">
            <div class="card shadow">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">Filtri Calendario</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label class="form-label">Mese</label>
                            <select class="form-select" name="month">
                                {% for i in range(1, 13) %}
                                <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Anno</label>
                            <select class="form-select" name="year">
                                {% for year in range(2020, 2030) %}
                                <option value="{{ year }}" {% if year == datetime.now().year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100">Filtra</button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Legenda</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge bg-primary me-2">●</span> Appuntamenti
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-success me-2">●</span> Eventi/Note
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-warning me-2">●</span> Follow-up
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-info me-2">●</span> Altri Appuntamenti
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per eventi giornalieri -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eventi del <span id="selectedDate"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="eventsList">
                    <!-- Eventi caricati dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <a href="{{ url_for('main.add_event') }}" class="btn btn-success">Nuovo Evento</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#calendar').fullCalendar({
        locale: 'it',
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        editable: false,
        eventClick: function(event) {
            // Gestisci click su evento
            alert('Evento: ' + event.title);
        },
        dayClick: function(date, jsEvent, view) {
            // Carica eventi per il giorno selezionato
            loadDayEvents(date.format('YYYY-MM-DD'));
        },
        events: function(start, end, timezone, callback) {
            // Carica eventi dal server
            var events = [];
            
            {% for appointment in appointments %}
            events.push({
                id: 'app_{{ appointment.id }}',
                title: '{{ appointment.nome_cliente }}',
                start: '{{ appointment.data_appuntamento.strftime("%Y-%m-%d") }}',
                color: '#007bff',
                textColor: '#fff'
            });
            {% endfor %}
            
            {% for oapp in oapps %}
            events.push({
                id: 'oapp_{{ oapp.id }}',
                title: '{{ oapp.nome_cliente }}',
                start: '{{ oapp.data_appuntamento.strftime("%Y-%m-%d") }}',
                color: '#17a2b8',
                textColor: '#fff'
            });
            {% endfor %}
            
            callback(events);
        }
    });
});

function loadDayEvents(date) {
    fetch(`{{ url_for('main.events') }}?date=${date}`)
        .then(response => response.json())
        .then(data => {
            const eventsList = document.getElementById('eventsList');
            const selectedDate = document.getElementById('selectedDate');
            
            selectedDate.textContent = new Date(date).toLocaleDateString('it-IT');
            
            if (data.events && data.events.length > 0) {
                let html = '<div class="list-group">';
                data.events.forEach(event => {
                    const typeColor = event.type === 'followup' ? 'warning' : 
                                    event.type === 'note' ? 'success' : 'primary';
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${event.title}</h6>
                                <span class="badge bg-${typeColor}">${event.type}</span>
                            </div>
                            ${event.note ? `<p class="mb-1">${event.note}</p>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                eventsList.innerHTML = html;
            } else {
                eventsList.innerHTML = '<p class="text-muted">Nessun evento per questa data</p>';
            }
            
            new bootstrap.Modal(document.getElementById('eventModal')).show();
        })
        .catch(error => {
            console.error('Errore nel caricamento eventi:', error);
        });
}
</script>
{% endblock %}
