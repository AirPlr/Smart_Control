{% extends "admin/base.html" %}

{% block title %}Gestione Clienti{% endblock %}

{% block content %}
<div class="admin-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="admin-page-title">
            <i class="fas fa-users me-2"></i>
            Gestione Clienti
        </h1>
        <div class="d-flex gap-2">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addClientModal">
                <i class="fas fa-user-plus me-2"></i>
                Nuovo Cliente
            </button>
            <button class="btn btn-info" onclick="refreshClients()">
                <i class="fas fa-sync-alt me-2"></i>
                Aggiorna
            </button>
        </div>
    </div>

    <!-- Filtri e Ricerca -->
    <div class="admin-card mb-4">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-search me-2"></i>
                Ricerca e Filtri
            </h5>
        </div>
        <div class="admin-card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Cerca per nome, telefono o email..." 
                               value="{{ search or '' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">Tutti i clienti</option>
                        <option value="venduto">Clienti con vendita</option>
                        <option value="potenziale">Clienti potenziali</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <i class="fas fa-search me-2"></i>
                            Cerca
                        </button>
                        <button class="btn btn-secondary" type="button" id="resetBtn">
                            <i class="fas fa-times me-2"></i>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista Clienti -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Elenco Clienti
                {% if clients %}
                <span class="badge bg-light text-dark ms-2">{{ clients|length }} clienti</span>
                {% endif %}
            </h5>
        </div>
        <div class="admin-card-body p-0">
            {% if clients %}
            <div class="list-group list-group-flush" id="clientList">
                {% for client in clients %}
                <div class="list-group-item client-item"
                     data-id="{{ client.id }}"
                     data-name="{{ client.nome }}"
                     data-address="{{ client.indirizzo or '' }}"
                     data-phone="{{ client.numero_telefono or '' }}"
                     data-email="{{ client.email or '' }}"
                     data-registrazione="{{ client.data_registrazione.strftime('%d/%m/%Y') }}"
                     data-note="{{ client.note or '' }}"
                     data-consultants="{% if client.consultants %}{% for c in client.consultants %}{{ c.nome }}{% if not loop.last %},{% endif %}{% endfor %}{% endif %}"
                     data-venduto="{{ 'true' if client.nome in sold_names else 'false' }}">
                    
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-user-circle text-primary fa-lg me-3"></i>
                                <div>
                                    <h5 class="mb-1 fw-bold">{{ client.nome }}</h5>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        Registrato il {{ client.data_registrazione.strftime('%d/%m/%Y') }}
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {% if client.indirizzo %}
                                    <div class="mb-1">
                                        <i class="fas fa-map-marker-alt text-info me-2"></i>
                                        <small>{{ client.indirizzo }}</small>
                                    </div>
                                    {% endif %}
                    <span class="mx-2">|</span>
                    <span class="me-2"><strong>Telefono:</strong> {{ client.numero_telefono or 'N/D' }}</span>
                    <span class="mx-2">|</span>
                    <span class="me-2"><strong>Email:</strong> {{ client.email or 'N/D' }}</span>
                    <span class="mx-2">|</span>
                    <span><strong>Registrazione:</strong> {{ client.data_registrazione.strftime('%d/%m/%Y') }}</span>
                    <span class="mx-2">|</span>
                    <span class="me-2"><strong>Note:</strong> <button type="button" class="btn btn-link p-0 note-edit-btn" data-id="{{ client.id }}">{{ client.note or 'N/D' }}</button></span>
                </div>
                
                {% if client.nome in sold_names %}
                    <span class="badge bg-success ms-2">Venduto</span>
                {% else %}
                    <span class="badge bg-danger ms-2">Non Venduto</span>
                {% endif %}
                {% if client.consultants %}
                    <div class="mt-1">
                        {% for consultant in client.consultants %}
                            <span class="badge bg-secondary">{{ consultant.nome }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <a href="{{ url_for('client_service', id=client.id) }}" class="btn btn-primary btn-sm">Follow-ups</a>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- Client Actions Modal -->
<div class="modal fade" id="clientModal" tabindex="-1" role="dialog" aria-labelledby="clientModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalLabel">Latest Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalContent">
                <p>Loading latest actions...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal modifica note -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalLabel">Modifica Note Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" id="noteInput" rows="4"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel">Filtri Ricerca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="filterVenduto" {% if venduto=='true' %}checked{% endif %}>
          <label class="form-check-label" for="filterVenduto">Solo Venduti</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="filterNonVenduto" {% if venduto=='false' %}checked{% endif %}>
          <label class="form-check-label" for="filterNonVenduto">Solo Non Venduti</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-primary" id="applyFiltersBtn">Applica Filtri</button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
    $(document).ready(function(){
        // setup filters with server values
        var filters = { venduto: null };
        // initial search input
        var serverSearch = "{{ search or '' }}";
        $('#searchInput').val(serverSearch);
        // initial venduto filters
        var serverVend = "{{ venduto or '' }}";
        if(serverVend === 'true') { filters.venduto = true; $('#filterVenduto').prop('checked', true); }
        else if(serverVend === 'false') { filters.venduto = false; $('#filterNonVenduto').prop('checked', true); }

        // Apri il modal dei filtri
        $('#filterBtn').on('click', function(){ $('#filterModal').modal('show'); });

        // Show client actions modal on click
        $('.client-item').on('click', function(){
            var clientId = $(this).data('id');
            var clientName = $(this).data('name');

            // Set the modal title dynamically
            $('#clientModalLabel').text(clientName + ' - Latest Actions');

            // AJAX GET call to retrieve client actions
            $.get('/client_actions', { id: clientId }, function(data){
                var html = '';
                if(data.appointments && data.appointments.length > 0){
                    html += '<h6>Appointments</h6><ul>';
                    data.appointments.forEach(function(item){
                        html += '<li>' + item + '</li>';
                    });
                    html += '</ul>';
                }
                if(data.otherAppointments && data.otherAppointments.length > 0){
                    html += '<h6>Altro</h6><ul>';
                    data.otherAppointments.forEach(function(item){
                        html += '<li>' + item + '</li>';
                    });
                    html += '</ul>';
                }
                if(data.followups && data.followups.length > 0){
                    html += '<h6>Follow-ups</h6><ul>';
                    data.followups.forEach(function(item, index){
                        if (index === 0){
                            html += '<li>Installazione Soft: ' + item.substring(0, 10) +  '</li>';
                        } else if (index === 1){
                            html += '<li>Visita di benvenuto: ' + item.substring(0, 10) + '</li>';
                        } else if (index >= 2 && index <= 12){
                            html += '<li>Visita di cortesia ' + (index - 1) + ': ' + item.substring(0, 10) + '</li>';
                        } else if (index === 13){
                            html += '<li>Fine della Garanzia: ' + item.substring(0, 10) + '</li>';
                        }
                    });
                    html += '</ul>';
                }
                if(data.otherFollowups && data.otherFollowups.length > 0){
                    html += '<h6>Altro</h6><ul>';
                    data.otherFollowups.forEach(function(item){
                        html += '<li>' + item + '</li>';
                    });
                    html += '</ul>';
                }
                $('#modalContent').html(html);
            });
            $('#clientModal').modal('show');
        });

        // Filter clients based on search input
        $('#searchInput').on('keyup', filterClients);
        // trigger search on Enter key
        $('#searchInput').on('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); $('#goBtn').click(); }});

        // Apply selected filters
        $('#applyFiltersBtn').on('click', function(){
            // venduto filter
            var sold = $('#filterVenduto').is(':checked');
            var unsold = $('#filterNonVenduto').is(':checked');
            if(sold && !unsold) filters.venduto = true;
            else if(!sold && unsold) filters.venduto = false;
            else filters.venduto = null;
            $('#filterModal').modal('hide');
            filterClients();
        });

        // Redirect to filtered page on Vai click
        $('#goBtn').on('click', function(){
            var q = $('#searchInput').val();
            var params = new URLSearchParams();
            if(q) params.append('search', q);
            if(filters.venduto !== null) params.append('venduto', filters.venduto);
            window.location.href = "{{ url_for('clients') }}?" + params.toString();
        });

        // unified filtering function
        function filterClients(){
            var q = $('#searchInput').val().toLowerCase();
            $('.client-item').each(function(){
                var data = $(this).data();
                var text = [data.name, data.address, data.phone, data.email, data.registrazione, data.note].join(' ').toLowerCase();
                var matchQ = !q || text.indexOf(q) !== -1;
                var matchVend = filters.venduto===null || (filters.venduto === true && data.venduto) || (filters.venduto === false && !data.venduto);
                if(matchQ && matchVend) $(this).show(); else $(this).hide();
            });
        }

        // Show note edit modal on click
        $('.note-edit-btn').on('click', function(e){
            e.stopPropagation();
            var clientId = $(this).data('id');
            var noteText = $(this).text() === 'N/D' ? '' : $(this).text();
            $('#noteInput').val(noteText);
            $('#noteModal').data('clientId', clientId).modal('show');
        });

        // Save note changes
        $('#saveNoteBtn').on('click', function(){
            var clientId = $('#noteModal').data('clientId');
            var newNote = $('#noteInput').val();
            $.post('/update_client_note', { id: clientId, note: newNote }, function(resp){
                if(resp.success){
                    $('button.note-edit-btn[data-id="'+clientId+'"]').text(newNote || 'N/D');
                    $('#noteModal').modal('hide');
                }
            });
        });
    });
</script>
{% endblock %}
{% endblock %}
