{% extends 'admin/base.html' %}

{% block title %}Aggiungi Appuntamento - Admin{% endblock %}

{% block page_title %}Aggiungi Nuovo Appuntamento{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Sistema</a></li>
<li class="breadcrumb-item active">Aggiungi Appuntamento</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header con azioni -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-primary">
                <i class="fas fa-calendar-plus me-2"></i>Aggiungi Nuovo Appuntamento
            </h1>
            <p class="text-muted mb-0">Registra un nuovo appuntamento nel sistema</p>
        </div>
        <div>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Torna alla Home
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Form principale -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit me-2"></i>Dettagli Appuntamento
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.add_appointment') }}">
                        <!-- Cliente -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-user me-2"></i>Nome Cliente
                                </label>
                                <input list="client-list" class="form-control" name="nome_cliente" id="nome_cliente" required oninput="checkClient(this)">
                                <datalist id="client-list">
                                    {% for client in clients %}
                                    <option value="{{ client.nome }}"></option>
                                    {% endfor %}
                                </datalist>
                                <small id="client-help" class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>Se il cliente non esiste, verrà registrato come nuovo.
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-phone me-2"></i>Numero di Telefono
                                </label>
                                <input type="tel" class="form-control" name="numero_telefono" required>
                            </div>
                        </div>

                        <!-- Indirizzo -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Indirizzo
                            </label>
                            <input type="text" class="form-control" name="indirizzo">
                        </div>

                        <!-- Consulenti -->
                        <div class="mb-3">
                            <label for="consultant" class="form-label">
                                <i class="fas fa-user-tie me-2"></i>Seleziona Consulenti
                            </label>
                            <select id="consultant" class="form-select">
                                <option value="" disabled selected>Scegli un consulente</option>
                                {% for consultant in consultants %}
                                <option value="{{ consultant.id }}">{{ consultant.nome }}</option>
                                {% endfor %}
                            </select>
                            
                            <!-- Lista consulenti selezionati -->
                            <div class="mt-2">
                                <div id="selected-consultants-container" style="display: none;">
                                    <label class="form-label small text-muted">Consulenti selezionati:</label>
                                    <ul id="selected-consultants" class="list-group list-group-flush"></ul>
                                </div>
                            </div>
                            
                            <!-- Input nascosto per inviare i consulenti selezionati -->
                            <input type="hidden" name="consultants" id="consultants-input">
                        </div>

                        <!-- Tipologia e Data -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-tags me-2"></i>Tipologia di Appuntamento
                                </label>
                                <select class="form-select" name="tipologia" required>
                                    <option value="Assistenza">Assistenza</option>
                                    <option value="Dimostrazione">Dimostrazione</option>
                                    <option value="Consumabili">Consumabili</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-2"></i>Data Appuntamento
                                </label>
                                <input type="date" class="form-control" name="data_appuntamento" required>
                            </div>
                        </div>

                        <!-- Stato e Richiamo -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-flag me-2"></i>Stato
                                </label>
                                <select class="form-select" name="stato" id="stato" required>
                                    <option value="completato">Completato</option>
                                    <option value="completato da richiamare">Completato da Richiamare</option>
                                    <option value="saltato da richiamare">Saltato da Richiamare</option>
                                    <option value="saltato da non richiamare">Saltato da Non Richiamare</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div id="recallDateContainer" style="display: none;">
                                    <label class="form-label">
                                        <i class="fas fa-clock me-2"></i>Data di Richiamo
                                    </label>
                                    <input type="date" class="form-control" name="data_richiamo">
                                </div>
                            </div>
                        </div>

                        <!-- Contatti e Appuntamenti -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-address-book me-2"></i>Contatti Raccolti
                                </label>
                                <input type="number" class="form-control" name="nominativi_raccolti" value="0" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-handshake me-2"></i>Appuntamenti Personali Presi
                                </label>
                                <input type="number" class="form-control" name="appuntamenti_personali" value="0" min="0">
                            </div>
                        </div>

                        <!-- Vendita -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="venduto" id="venduto">
                                <label class="form-check-label" for="venduto">
                                    <i class="fas fa-check-circle me-2"></i>Vendita Conclusa
                                </label>
                            </div>
                        </div>

                        <!-- Note -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-sticky-note me-2"></i>Note
                            </label>
                            <textarea class="form-control" name="note" rows="3" placeholder="Aggiungi note sull'appuntamento..."></textarea>
                        </div>

                        <!-- Pulsanti di azione -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('main.index') }}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Annulla
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Salva Appuntamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar informativa -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-info-circle me-2"></i>Guida Rapida
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-primary">
                            <i class="fas fa-user me-2"></i>Cliente
                        </h6>
                        <p class="text-muted small">
                            Inizia a digitare il nome del cliente. Se esiste nel sistema, apparirà nell'elenco. 
                            Altrimenti verrà creato un nuovo cliente.
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-success">
                            <i class="fas fa-users me-2"></i>Consulenti
                        </h6>
                        <p class="text-muted small">
                            Puoi assegnare più consulenti ad un singolo appuntamento. 
                            Seleziona un consulente alla volta dal menu a tendina.
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-warning">
                            <i class="fas fa-flag me-2"></i>Stati Appuntamento
                        </h6>
                        <p class="text-muted small">
                            • <strong>Completato:</strong> Appuntamento concluso<br>
                            • <strong>Completato da richiamare:</strong> Richiede follow-up<br>
                            • <strong>Saltato da richiamare:</strong> Cliente da ricontattare<br>
                            • <strong>Saltato da non richiamare:</strong> Cliente non interessato
                        </p>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Suggerimento:</strong> Compila tutti i campi disponibili per ottenere 
                        statistiche più accurate nei report.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const consultantSelect = document.getElementById("consultant");
    const selectedConsultantsList = document.getElementById("selected-consultants");
    const selectedConsultantsContainer = document.getElementById("selected-consultants-container");
    const consultantsInput = document.getElementById("consultants-input");
    const statoSelect = document.getElementById('stato');
    const recallDateContainer = document.getElementById('recallDateContainer');
    const tipologiaSelect = document.querySelector('select[name="tipologia"]');
    const vendutoCheckbox = document.getElementById('venduto');
    
    let selectedConsultants = [];

    // Gestione selezione consulenti
    consultantSelect.addEventListener("change", function () {
        const consultantId = this.value;
        const consultantName = this.options[this.selectedIndex].text;

        if (consultantId && !selectedConsultants.some(c => c.id === consultantId)) {
            selectedConsultants.push({ id: consultantId, name: consultantName });
            updateConsultantList();
        }
        
        // Reset della selezione
        this.value = "";
    });

    function updateConsultantList() {
        selectedConsultantsList.innerHTML = "";
        
        if (selectedConsultants.length > 0) {
            selectedConsultantsContainer.style.display = 'block';
            
            selectedConsultants.forEach((consultant, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    <span><i class="fas fa-user-tie me-2"></i>${consultant.name}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeConsultant(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                selectedConsultantsList.appendChild(li);
            });
        } else {
            selectedConsultantsContainer.style.display = 'none';
        }

        consultantsInput.value = JSON.stringify(selectedConsultants.map(c => c.id));
    }

    // Funzione globale per rimuovere consulenti
    window.removeConsultant = function (index) {
        selectedConsultants.splice(index, 1);
        updateConsultantList();
    };
    
    // Gestione stato appuntamento e data richiamo
    statoSelect.addEventListener('change', function () {
        if (this.value === 'completato da richiamare' || this.value === 'saltato da richiamare') {
            recallDateContainer.style.display = 'block';
        } else {
            recallDateContainer.style.display = 'none';
        }
    });
    
    // Gestione checkbox venduto in base alla tipologia
    function updateVenduto() {
        const tipologia = tipologiaSelect.value;
        if (tipologia === 'Consegna' || tipologia === 'Redemo') {
            vendutoCheckbox.checked = false;
            vendutoCheckbox.disabled = true;
        } else {
            vendutoCheckbox.disabled = false;
        }
    }
    
    tipologiaSelect.addEventListener('change', updateVenduto);
    updateVenduto();
    
    // Validazione cliente
    window.checkClient = function(input) {
        const options = document.getElementById("client-list").options;
        let found = false;
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === input.value.trim()) {
                found = true;
                break;
            }
        }
        const helpText = document.getElementById("client-help");
        if (found) {
            helpText.innerHTML = '<i class="fas fa-check-circle me-1 text-success"></i>Cliente esistente selezionato.';
            helpText.className = "form-text text-success";
        } else {
            helpText.innerHTML = '<i class="fas fa-info-circle me-1"></i>Cliente non trovato. Verrà registrato come nuovo.';
            helpText.className = "form-text text-muted";
        }
    };
    
    // Imposta data di default ad oggi
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="data_appuntamento"]').value = today;
});
</script>
{% endblock %}